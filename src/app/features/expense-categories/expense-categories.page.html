<div class="flex items-center justify-between">
  <h2 class="text-xl font-semibold text-slate-900">Expense Categories</h2>
  <div class="flex items-center gap-2">
    <button
      *ngIf="perm.canCreate('EXPENSE_CATEGORIES')"
      class="rounded-xl bg-indigo-950 px-3 py-2 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-70"
      (click)="openCreate()"
      [disabled]="loading()"
    >
      Add Category
    </button>
  </div>
</div>

<div *ngIf="confirmDeleteOpen()" class="fixed inset-0 z-50">
  <div class="absolute inset-0 bg-slate-900/40" (click)="cancelDeleteConfirm()"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div
      class="w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl ring-1 ring-slate-200"
      (click)="$event.stopPropagation()"
    >
      <div class="text-base font-semibold text-slate-900">Delete category?</div>
      <div class="mt-2 text-sm text-slate-600">
        Are you sure you want to delete this category? This action cannot be undone.
      </div>

      <div class="mt-5 flex items-center justify-end gap-2">
        <button
          type="button"
          class="rounded-xl bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-200"
          (click)="cancelDeleteConfirm()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="rounded-xl bg-red-700 px-4 py-2 text-sm font-semibold text-white hover:bg-red-800"
          (click)="confirmDelete()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<div class="mt-4 grid grid-cols-1 gap-4">
  <section class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-100">
    <div class="flex items-center justify-between">
      <h3 class="text-base font-semibold text-slate-900">List</h3>
      <button
        class="rounded-xl bg-slate-100 px-3 py-2 text-xs font-semibold text-slate-800 hover:bg-slate-200 disabled:cursor-not-allowed disabled:opacity-70"
        (click)="load()"
        [disabled]="loading()"
      >
        Refresh
      </button>
    </div>

    <div class="mt-3 text-sm text-red-700" *ngIf="error()">{{ error() }}</div>

    <div class="mt-3 overflow-auto rounded-xl ring-1 ring-slate-100">
      <table class="w-full border-collapse text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Name</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Description</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of categories()" class="border-t border-slate-100">
            <td class="px-3 py-2 font-semibold">{{ c.name }}</td>
            <td class="px-3 py-2">{{ c.description || '-' }}</td>
            <td class="px-3 py-2">
              <span class="text-slate-800" [class.text-red-700]="!c.active">{{ c.active ? 'Active' : 'Inactive' }}</span>
            </td>
            <td class="px-3 py-2">
              <div class="flex gap-2">
                <button
                  *ngIf="perm.canEdit('EXPENSE_CATEGORIES')"
                  class="rounded-lg bg-indigo-950 px-2 py-1 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-70"
                  (click)="openEdit(c)"
                  [disabled]="loading()"
                >
                  Edit
                </button>
                <button
                  *ngIf="perm.canDelete('EXPENSE_CATEGORIES')"
                  class="rounded-lg bg-red-700 px-2 py-1 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-70"
                  (click)="openDeleteConfirm(c)"
                  [disabled]="loading()"
                >
                  Delete
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!categories().length" class="border-t border-slate-100">
            <td class="px-3 py-6 text-center text-sm text-slate-600" colspan="4">No categories</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

<div *ngIf="dialogOpen()" class="fixed inset-0 z-50">
  <div class="absolute inset-0 bg-slate-900/40" (click)="closeDialog()"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-base font-semibold text-slate-900">{{ editingId() ? 'Edit Category' : 'Add Category' }}</div>
          <div class="mt-1 text-xs text-slate-500">Manage expense categories.</div>
        </div>
        <button type="button" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold" (click)="closeDialog()">Close</button>
      </div>

      <form class="mt-4 grid gap-3" [formGroup]="form" (ngSubmit)="save()">
        <label class="grid gap-2 text-xs text-slate-700">
          Name
          <input class="rounded-xl border border-slate-200 px-3 py-2 text-sm" formControlName="name" />
        </label>

        <label class="grid gap-2 text-xs text-slate-700">
          Description
          <input class="rounded-xl border border-slate-200 px-3 py-2 text-sm" formControlName="description" />
        </label>

        <label class="grid gap-2 text-xs text-slate-700">
          Status
          <select class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" formControlName="active">
            <option [ngValue]="true">Active</option>
            <option [ngValue]="false">Inactive</option>
          </select>
        </label>

        <div class="text-sm text-red-700" *ngIf="error()">{{ error() }}</div>

        <div class="mt-1 flex items-center justify-end gap-2">
          <button type="button" class="rounded-xl bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-200" (click)="closeDialog()">
            Cancel
          </button>
          <button
            class="rounded-xl bg-indigo-950 px-4 py-2 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-70"
            type="submit"
            [disabled]="form.invalid || loading()"
          >
            {{ loading() ? 'Saving...' : 'Save' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
