<div class="flex items-center">
  <h2 class="text-xl font-semibold text-slate-900">Inventory</h2>
</div>

<div class="mt-4 rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-100">
  <form class="grid gap-3 sm:grid-cols-[1fr_auto_auto_auto_auto] sm:items-end" [formGroup]="filterForm" (ngSubmit)="load()">
    <label class="grid gap-2 text-xs text-slate-700">
      Search (SKU / Name / Batch)
      <input
        class="rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-purple-500"
        formControlName="query"
      />
    </label>

    <label class="grid gap-2 text-xs text-slate-700">
      Low stock threshold
      <input
        class="w-32 rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-purple-500"
        type="number"
        formControlName="lowStockThreshold"
      />
    </label>

    <label class="flex items-center gap-2 text-sm text-slate-700">
      <input type="checkbox" formControlName="includeZero" />
      Include zero qty
    </label>

    <button class="rounded-xl bg-indigo-950 px-4 py-2 text-sm font-semibold text-white" type="submit">
      Apply
    </button>
  </form>

  <div class="mt-3 text-sm text-red-700" *ngIf="error()">{{ error() }}</div>

  <div class="mt-3 overflow-auto rounded-xl ring-1 ring-slate-100">
    <table class="w-full border-collapse text-sm">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">SKU</th>
          <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Product</th>
          <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Batch</th>
          <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Expiry</th>
          <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Location</th>
          <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">Status</th>
          <th class="px-3 py-2 text-right text-xs font-semibold text-slate-600">Qty</th>
          <th class="px-3 py-2 text-right text-xs font-semibold text-slate-600">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let i of items()" class="border-t border-slate-100" [class.bg-amber-50]="isLowStock(i)">
          <td class="px-3 py-2">{{ i.sku }}</td>
          <td class="px-3 py-2">{{ i.productName }}</td>
          <td class="px-3 py-2">{{ i.batchNumber }}</td>
          <td class="px-3 py-2">{{ i.expiryDate }}</td>
          <td class="px-3 py-2">{{ i.location }}</td>
          <td class="px-3 py-2">
            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-semibold ring-1" [class]="statusClasses(i)">
              {{ statusLabel(i) }}
            </span>
          </td>
          <td class="px-3 py-2 text-right font-semibold">
            <span class="inline-flex items-center gap-2">
              <span>
                {{ i.qtyOnHand }}
                <!-- <span class="text-xs font-medium text-slate-500" *ngIf="i.unitOfMeasure">{{ i.unitOfMeasure }}</span> -->
              </span>
              <!-- <span
                *ngIf="isLowStock(i)"
                class="inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-900 ring-1 ring-amber-200"
              >
                Low
              </span> -->
            </span>
          </td>
          <td class="px-3 py-2 text-right">
            <button
              class="rounded-lg bg-slate-900 px-2 py-1 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-70"
              (click)="openAdjust(i)"
              [disabled]="loading()"
            >
              Adjust
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div
  *ngIf="toastMessage()"
  class="fixed right-4 top-4 z-50"
  role="status"
  aria-live="polite"
>
  <div
    class="flex items-start gap-3 rounded-xl px-4 py-3 text-sm font-medium shadow-lg ring-1"
    [class.bg-emerald-50]="toastVariant() === 'success'"
    [class.text-emerald-900]="toastVariant() === 'success'"
    [class.ring-emerald-200]="toastVariant() === 'success'"
    [class.bg-red-50]="toastVariant() === 'error'"
    [class.text-red-900]="toastVariant() === 'error'"
    [class.ring-red-200]="toastVariant() === 'error'"
  >
    <div class="flex-1">{{ toastMessage() }}</div>
    <button class="text-xs font-semibold opacity-80 hover:opacity-100" (click)="dismissToast()">Close</button>
  </div>
</div>

<div *ngIf="adjustDialogOpen()" class="fixed inset-0 z-40">
  <div class="absolute inset-0 bg-slate-900/40" (click)="cancelAdjust()"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-xl ring-1 ring-slate-200">
      <div class="text-base font-semibold text-slate-900">Adjust Inventory</div>
      <div class="mt-2 text-sm text-slate-600">
        {{ pendingAdjust()?.sku }} - {{ pendingAdjust()?.productName }}
        (Batch {{ pendingAdjust()?.batchNumber }}, {{ pendingAdjust()?.location }})
      </div>

      <div class="mt-4 grid gap-3" [formGroup]="adjustForm">
        <label class="grid gap-2 text-xs text-slate-700">
          Delta (use negative to subtract)
          <input
            class="rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-purple-500"
            type="number"
            formControlName="delta"
          />
        </label>

        <label class="grid gap-2 text-xs text-slate-700">
          Note (optional)
          <input
            class="rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-purple-500"
            formControlName="note"
          />
        </label>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button
          class="rounded-xl bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-200 disabled:cursor-not-allowed disabled:opacity-70"
          (click)="cancelAdjust()"
          [disabled]="loading()"
        >
          Cancel
        </button>
        <button
          class="rounded-xl bg-indigo-950 px-4 py-2 text-sm font-semibold text-white hover:bg-purple-900 disabled:cursor-not-allowed disabled:opacity-70"
          (click)="confirmAdjust()"
          [disabled]="loading() || adjustForm.invalid"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>
